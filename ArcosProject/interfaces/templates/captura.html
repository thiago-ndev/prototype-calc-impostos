{% extends 'base.html' %} 

{% block page_title %}Captura NFe{% endblock %}
{% block header_title %}Gestor de XML (NFe){% endblock %}

{% block header_nav %}
    <a href="{% url 'home' %}">Dashboard</a>
    <a href="#" class="active">Consulta NFe</a>
    <a href="#">Importação</a>
{% endblock %}

{% block content %}
<div class="welcome-banner">
    <h1><i class="fas fa-search" style="font-size: 25px; margin-right: 10px"></i>Consulta de Notas Fiscais (NFe/NFCe)</h1>
</div>
    <div class="filter-card">

        <div class="filter-grid">
            <div class="form-group">
                <label for="data-inicio">Data Início</label>
                <input type="date" id="data-inicio" class="form-control">
            </div>
            <div class="form-group">
                <label for="data-fim">Data Fim</label>
                <input type="date" id="data-fim" class="form-control">
            </div>
            <div>
                <button class="btn btn-search" onclick="buscarNotas()">
                    <i class="fas fa-search"></i> Buscar Notas
                </button>
            </div>
        </div>
    </div>

    <div id="loading" style="text-align: center; display: none; padding: 20px; color: #666;">
        <i class="fas fa-spinner fa-spin"></i> Buscando dados na Receita Federal...
    </div>

    <div id="resultado-container" class="table-container" style="display: none;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h3 style="margin: 0; color: #333;">Resultados da Busca</h3>
            <a href="#" class="btn btn-danger">Exportar XML em Lotes</a>
        </div>

        <div style="overflow-x: auto;">
            <table id="tabela-notas">
                <thead>
                    <tr>
                        <th>Emissão</th>
                        <th>Captura</th>

                        <th>CNPJ Prestador</th>
                        <th>Razão Social</th>
                        <th>Município</th>
                        <th>UF</th>

                        <th>CNPJ Tomador</th>
                        <th>Razão Social</th>
                        <th>Município</th>
                        <th>UF</th>

                        <th>CNPJ Intermediário</th>
                        <th>Razão Social</th>
                        <th>Município</th>
                        <th>UF</th>

                        <th>Numero NF</th>
                        <th>Valor Bruto</th>
                        <th>Código</th>
                        <th>NBS</th>
                        <th>Descrição</th>

                        <th>IRRF</th>
                        <th>IRRF Alíquota</th>
                        <th>ISS Retido</th>
                        <th>ISS Alíquota S.Nacional</th>
                        <th>INSS Retido</th>
                        <th>CSRF Retido</th>
                        <th>Personalidade Jurídica</th>
                        <th>CBS</th>
                        <th>CBS Alíquota</th>
                        <th>IBS</th>
                        <th>IBS Alíquota</th>

                        <th>Valor Líquido</th>
                        <th>Chave NF</th>
                    </tr>
                </thead>
                <tbody>
                    </tbody>
            </table>
        </div>

    </div>

    <script>
        // Função para formatar moeda (BRL)
        function formatMoney(value) {
            if (value === undefined || value === null) return "R$ 0,00";
            return parseFloat(value).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        }

        // Função para formatar data
        // O Python envia DD-MM-YYYY (ex: 21-01-2026). Vamos apenas trocar os traços por barras.
        function formatDate(dateString) {
            if (!dateString) return "-";
            return dateString.replace(/-/g, '/');
        }

        async function buscarNotas() {
            const inicio = document.getElementById('data-inicio').value;
            const fim = document.getElementById('data-fim').value;
            const loading = document.getElementById('loading');
            const container = document.getElementById('resultado-container');
            const tbody = document.querySelector('#tabela-notas tbody');

            // Validação simples
            if (!inicio || !fim) {
                alert("Por favor, selecione o período de início e fim.");
                return;
            }

            // UI Feedback
            loading.style.display = 'block';
            container.style.display = 'none';
            tbody.innerHTML = '';

            try {
                const url = `{% url 'notas' %}?inicio=${inicio}&fim=${fim}`;
                console.log("Tentando buscar em:", url); // Log para Debug

                const response = await fetch(url);

                // Verifica se a resposta HTTP foi sucesso (200)
                if (!response.ok) {
                    throw new Error(`Erro HTTP: ${response.status} - ${response.statusText}`);
                }

                const json = await response.json();
                console.log("Dados recebidos:", json); // Log para Debug

                // O backend retorna {'data': [...]}
                const notas = json.data;

                if (!notas || notas.length === 0) {
                    alert("Nenhuma nota encontrada para este período.");
                    loading.style.display = 'none';
                    return;
                }

                // Popula a tabela
                notas.forEach(nota => {
                    const tr = document.createElement('tr');


                    tr.innerHTML = `
                        <td>${formatDate(nota.data_emissao)}</td>
                        <td>${formatDate(nota.data_captura)}</td>

                        <td>${nota.cnpj_tomador || '-'}</td>
                        <td>${nota.razao_tomador || '-'}</td>
                        <td>${nota.municipio_tomador}</td>
                        <td>${nota.uf_tomador}</td>

                        <td>${nota.cnpj_prestador || '-'}</td>
                        <td>${nota.razao_prestador || '-'}</td>
                        <td>${nota.municipio_prestador}</td>
                        <td>${nota.uf_prestador}</td>

                        <td>${nota.cnpj_intermediario || '-'}</td>
                        <td>${nota.razao_intermediario || '-'}</td>
                        <td>${nota.municipio_intermediario}</td>
                        <td>${nota.uf_intermediario}</td>

                        <td>${nota.numero_nf || '-'}</td>
                        <td style="font-weight:bold;">${formatMoney(nota.valor_bruto)}</td>
                        <td>${nota.codigo_servico || '-'}</td>
                        <td>${nota.nbs || '-'}</td>
                        <td>${nota.nbs_descricao || '-'}</td>

                        <td>${formatMoney(nota.irrf)}</td>
                        <td>${nota.irrf_aliq}</td>
                        <td>${formatMoney(nota.iss)}</td>
                        <td>${nota.iss_aliq}</td>
                        <td>${formatMoney(nota.inss)}</td>
                        <td>${formatMoney(nota.csrf)}</td>

                        <td>${nota.personalidade_jur}</td>

                        <td>${formatMoney(nota.cbs)}</td>
                        <td>${nota.cbs_aliq}</td>
                        <td>${formatMoney(nota.ibs)}</td>
                        <td>${nota.ibs_aliq}</td>

                        <td>${nota.valor_liquido}</td>
                        <td>${nota.chave_nf}</td>
                    `;
                    tbody.appendChild(tr);
                });

                // Mostra a tabela
                container.style.display = 'block';

            } catch (error) {
                console.error("Erro detalhado:", error);
                alert("Ocorreu um erro ao buscar os dados. Verifique o Console (F12) para detalhes.");
            } finally {
                loading.style.display = 'none';
            }
        }
    </script>

{% endblock %}