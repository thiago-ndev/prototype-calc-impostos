{% extends "base.html" %}

{% block page_title %}Apuração - IVA Dual{% endblock %}

{% block header_title %}Arcos IVA Tax Dual{% endblock %}

{% block header_nav %}
    <a href="{% url 'operacoes' %}">Operações</a>
    <a href="{% url 'apuracao' %}" class="active">Apuração</a> <a href="{% url 'pagamento' %}">Pagamento</a>
{% endblock %}

{% block content %}
    <h1>Apuração Assistida</h1>

    <div style="margin-bottom: 20px;">
        <p><strong>Timeline:</strong> Andamento → Ajuste → Encerrada </p>
        <div class="grid-2">
            <div class="field-group">
                <label class="field-title">Período</label>
                <span>01/2026</span> | <span>Em Andamento</span>
            </div>
            <div class="field-group">
                <label class="field-title">Status do Período</label>
                <span>Original Em Andamento</span>
            </div>
        </div>
    </div>

    <hr>

    <div class="grid-2">
        <div class="field-group"><label class="field-title">Receita</label><div class="data-card">R$ 1.000.000,00</div></div>
        <div class="field-group"><label class="field-title">Valores Corretagem</label><div class="data-card">R$ 90.000,00</div></div>
        <div class="field-group"><label class="field-title">Sinistros</label><div class="data-card">R$ 350.000,00</div></div>
        <div class="field-group"><label class="field-title">Base de Cálculo</label><div class="data-card">R$ 560.000,00</div></div>

        <div class="field-group">
            <label class="field-title">Receita Financeira - Ativos Garantidores</label>
            <div class="data-card">
                <input type="number"
                       id="input-receita"
                       oninput="atualizarTudo()"
                       name="receita"
                       placeholder="0,00"
                       style="border: none; background: transparent; width: 100%; font-size: 1rem;">
            </div>
        </div>

        <div class="field-group">
            <label class="field-title">Alíquota (%)</label>
            <div class="data-card">
                <select id="input-aliquota" oninput="atualizarTudo()" name="aliquota" style="border: none; background: transparent; width: 100%; font-size: 1rem;">
                    <option value="10.85">10,85</option>
                    <option value="11">11,00</option>
                    <option value="11.15">11,15</option>
                    <option value="11.30">11,30</option>
                    <option value="11.50">11,50</option>
                    <option value="12.50">12,50</option>
                </select>
            </div>
        </div>
    </div>

    <div class="grid-2" style="margin-top: 20px;">
        <div class="field-group" style="background-color: #ff8b94;">
            <label class="field-title">Total de Débitos</label>
            <div class="data-card" id="resultado-debitos">R$ 0,00</div>
        </div>

        <div class="field-group" style="background-color: #90d2d8;">
            <label class="field-title">Total de Créditos</label>
            <div class="data-card" id="val-total-creditos-resumo">R$ 15.000,00</div>
        </div>

        <div class="field-group" style="background-color: #d4edda;">
            <label class="field-title">IVA a Pagar / Resultado do Período</label>
            <div class="data-card" id="resultado-iva" style="font-weight: bold;">R$ -15.000,00</div>
        </div>
    </div>

    <hr>

    <h2>Operações de Crédito</h2>

    <h3>Portal RT</h3>
    <div class="grid-2">
        <div class="field-group"><label class="field-title">Total de Créditos</label><div class="data-card">R$ 35.000,00</div></div>
        <div class="field-group"><label class="field-title">Não Apropriados</label><div class="data-card">R$ 15.000,00</div></div>

        <div class="field-group" style="background-color: #d4edda;">
            <label class="field-title">Apropriados</label>
            <div class="data-card" id="val-apropriados">R$ 20.000,00</div>
        </div>

        <div class="field-group" style="background-color: #90d2d8;">
            <label class="field-title">Utilizados</label>
            <div class="data-card">
                <input type="number"
                       id="input-utilizados"
                       oninput="atualizarTudo()"
                       value="15000"
                       style="border: none; background: transparent; width: 100%; font-size: 1rem;">
            </div>
        </div>

        <div class="field-group" style="background-color: #ff8b94;">
            <label class="field-title">Não Utilizados</label>
            <div class="data-card" id="val-nao-utilizados">R$ 5.000,00</div>
        </div>
    </div>

    <h3>Captura (Informações Complementares)</h3>
    <div class="grid-2">
        <div class="field-group"><label class="field-title">Total de Créditos</label><div class="data-card">R$ 35.000,00</div></div>
        <div class="field-group"><label class="field-title">Créditos do Mês</label><div class="data-card">R$ 25.000,00</div></div>
        <div class="field-group"><label class="field-title">Meses Anteriores</label><div class="data-card">R$ 10.000,00</div></div>
    </div>

    <hr>

    <h2>Destinação do Saldo Apropriado Não Utilizado</h2>
    <div class="grid-2">
        <div class="field-group">
            <label class="field-title">Enviar para Período Seguinte</label>
            <div class="data-card" id="val-ressarcimento1">R$ 5.000,00</div>

            <form action="{% url 'receita' %}" method="POST">
                {% csrf_token %}
                <input type="hidden" name="aliquota_envio" id="hidden_aliquota">
                <input type="hidden" name="receita" id="hidden_receita">
                <input type="hidden" name="utilizados" id="hidden_utilizados">
                <button type="submit" class="btn btn-success" style="margin-top: 10px;">Enviar</button>
            </form>
        </div>
        <div class="field-group">
            <label class="field-title">Enviar para Ressarcimento</label>
            <div class="data-card" id="val-ressarcimento">R$ 5.000,00</div>
            <button class="btn-gray" style="margin-top: 10px; background-color: gray; color: white; border: none; padding: 10px 20px; cursor: pointer; border-radius: 5px;">Enviar</button>
        </div>
    </div>

<script>
    function formatarMoeda(valor) {
        return valor.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
    }

    // Função Mestra que chama tudo
    function atualizarTudo() {
        calcularCreditos(); // Primeiro calcula os créditos (pois o TotalCreditos depende do Utilizados)
        calcularValores();  // Depois calcula o IVA (pois depende do TotalCreditos atualizado)
    }

    function calcularCreditos() {
        const apropriados = 20000.00;
        let utilizados = parseFloat(document.getElementById('input-utilizados').value);
        if (isNaN(utilizados)) { utilizados = 0; }

        const naoUtilizados = apropriados - utilizados;

        // Atualiza campos de "Não Utilizados" e "Ressarcimento"
        document.getElementById('val-nao-utilizados').innerText = formatarMoeda(naoUtilizados);
        document.getElementById('val-ressarcimento').innerText = formatarMoeda(naoUtilizados);
        document.getElementById('val-ressarcimento1').innerText = formatarMoeda(naoUtilizados);

        // Atualiza o Input Hidden para envio ao Backend
        if(document.getElementById('hidden_utilizados')) document.getElementById('hidden_utilizados').value = utilizados;

        // Estilização
        const elNaoUtil = document.getElementById('val-nao-utilizados').parentElement;
        if (naoUtilizados < 0) {
            elNaoUtil.style.backgroundColor = '#dc3545';
            elNaoUtil.style.color = 'white';
        } else {
            elNaoUtil.style.backgroundColor = '#ff8b94';
            elNaoUtil.style.color = 'black';
        }
    }

    function calcularValores() {
        const baseCalculo = 560000.00;

        // ATUALIZADO: Total de Créditos agora vem direto do input 'Utilizados'
        let utilizados = parseFloat(document.getElementById('input-utilizados').value);
        if (isNaN(utilizados)) { utilizados = 0; }
        const totalCreditos = utilizados;

        // Atualiza visualmente o Total de Créditos no Resumo Superior
        document.getElementById('val-total-creditos-resumo').innerText = formatarMoeda(totalCreditos);

        // Pega inputs de Alíquota e Receita
        let aliquota = parseFloat(document.getElementById('input-aliquota').value);
        let receitaExtra = parseFloat(document.getElementById('input-receita').value);

        if (isNaN(aliquota)) { aliquota = 0; }
        if (isNaN(receitaExtra)) { receitaExtra = 0; }

        if(document.getElementById('hidden_aliquota')) document.getElementById('hidden_aliquota').value = aliquota;
        if(document.getElementById('hidden_receita')) document.getElementById('hidden_receita').value = receitaExtra;

        // Cálculo do IVA
        const baseTotal = baseCalculo + receitaExtra;
        const totalDebitos = baseTotal * (aliquota / 100);

        // IVA = Débitos - Créditos (agora dinâmico baseados em Utilizados)
        const ivaPagar = totalDebitos - totalCreditos;

        document.getElementById('resultado-debitos').innerText = formatarMoeda(totalDebitos);
        document.getElementById('resultado-iva').innerText = formatarMoeda(ivaPagar);
    }

    window.onload = function() {
        // Recupera valores vindos do backend (sessão/recarga)
        {% if aliquota_informada %}
            document.getElementById('input-aliquota').value = "{{ aliquota_informada }}";
        {% endif %}

        {% if receita_informada %}
            document.getElementById('input-receita').value = "{{ receita_informada }}";
        {% endif %}

        {% if utilizados_informado %}
            document.getElementById('input-utilizados').value = "{{ utilizados_informado }}";
        {% endif %}

        atualizarTudo();
    }
</script>

{% if exibir_modal_confirmacao %}
    <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 999;"></div>
    <div style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.2); z-index: 1000; text-align: center; border: 2px solid #106f36;">
        <h3 style="color: #333;">Confirmação de Envio</h3>
        <p>Valor calculado a Pagar: <strong>{{ iva_formatado }}</strong></p>
        <p>Deseja realmente enviar os dados para a Receita Federal?</p>
        <div style="margin-top: 20px; display: flex; gap: 15px; justify-content: center;">
            <a href="{% url 'apuracao' %}" class="btn btn-danger" style="text-decoration: none;">Não</a>
            <form action="{% url 'receita' %}" method="POST">
                {% csrf_token %}
                <input type="hidden" name="confirmacao_final" value="sim">
                <input type="hidden" name="iva_pagar_final" value="{{ iva_calculado }}">
                <button type="submit" class="btn btn-success">Sim, confirmar</button>
            </form>
        </div>
    </div>
{% endif %}
{% endblock %}